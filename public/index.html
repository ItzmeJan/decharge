<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>⚡ EV Charging DApp — Modern UI</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  /* ---------- Base / Theme variables ---------- */
  :root{
    --accent-1: linear-gradient(135deg,#667eea,#764ba2);
    --accent-2: linear-gradient(135deg,#ff7e5f,#feb47b);
    --glass: rgba(255,255,255,0.12);
  }
  body { margin:0; font-family: "Inter", "Segoe UI", Roboto, system-ui, -apple-system; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; transition: background .35s, color .35s; }

  /* Light / Dark */
  body.light { --bg: #f2f6fb; --text:#0f172a; --card:#ffffff; --card-2:#f8fbff; --glass: rgba(255,255,255,0.6); }
  body.dark  { --bg: #0f1224; --text:#f5f7fb; --card:#141423; --card-2:#161627; --glass: rgba(255,255,255,0.03); }

  body { background: var(--bg); color: var(--text); height:100vh; overflow:hidden; }

  /* ---------- Layout ---------- */
  .app {
    display:flex;
    height:100vh;
    width:100%;
    position:relative;
  }

  /* Sidebar */
  .sidebar {
    width:60px;
    min-width:60px;
    background: var(--glass);
    backdrop-filter: blur(8px);
    border-top-right-radius:16px;
    border-bottom-right-radius:16px;
    display:flex; /* Visible by default on desktop */
    flex-direction:column;
    align-items:center;
    padding:12px 8px;
    gap:8px;
    box-shadow: 4px 8px 30px rgba(2,6,23,0.12);
    z-index:50;
  }

  .sidebar .icon-btn {
    width:44px; height:44px; border-radius:50%;
    border:none; cursor:pointer; 
    display:flex; 
    align-items:center; 
    justify-content:center;
    font-size:16px; color:#fff; background: rgba(255,255,255,0.06); position:relative; overflow:hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    text-align:center;
    line-height:1;
    opacity: 0;
    transform: translateX(-20px) scale(0.8);
    animation: sidebarButtonFadeIn 0.8s ease-out forwards;
  }
  .sidebar .icon-btn:hover { 
    transform: scale(1.15) translateY(-3px); 
    background: rgba(255,255,255,0.2);
    box-shadow: 0 12px 30px rgba(255,255,255,0.15);
    filter: brightness(1.2);
  }
  .sidebar .icon-btn:active {
    transform: scale(1.08) translateY(-1px);
    transition: all 0.15s ease;
  }
  
  @keyframes sidebarButtonFadeIn {
    0% {
      opacity: 0;
      transform: translateX(-20px) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }
  
  /* Staggered animation for sidebar buttons */
  .sidebar .icon-btn:nth-child(1) { animation-delay: 0.1s; }
  .sidebar .icon-btn:nth-child(2) { animation-delay: 0.2s; }
  .sidebar .icon-btn:nth-child(3) { animation-delay: 0.3s; }
  .sidebar .icon-btn:nth-child(4) { animation-delay: 0.4s; }
  .sidebar .icon-btn:nth-child(5) { animation-delay: 0.5s; }
  .sidebar .icon-btn:nth-child(6) { animation-delay: 0.6s; }

  /* ripple */
  .ripple { position:absolute; border-radius:50%; transform:scale(0); animation:ripple .6s linear; background: rgba(255,255,255,0.45); pointer-events:none; }
  @keyframes ripple { to { transform:scale(4); opacity:0; } }

  /* Main area */
  .main {
    flex:1; display:flex; flex-direction:column; gap:14px; padding:18px; overflow:hidden;
  }

  /* top header row */
  .header {
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand {
    display:flex; align-items:center; gap:12px;
  }
  .brand .logo {
    width:46px; height:46px; border-radius:12px; background:var(--accent-1); display:grid; place-items:center; color:#fff; font-weight:800; box-shadow:0 6px 18px rgba(102,126,234,.18);
  }
  .brand h1 { font-size:18px; letter-spacing:0.2px; margin:0; }
  .header .controls { display:flex; align-items:center; gap:12px; }

  .btn {
    background:var(--accent-1); color:white; border:none; padding:10px 16px; border-radius:12px; cursor:pointer;
    font-weight:700; letter-spacing:0.2px; 
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    position: relative;
    overflow: hidden;
  }
  .btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    filter: brightness(1.1);
  }
  .btn:active { 
    transform: scale(.96) translateY(0);
    transition: all 0.1s ease;
  }
  .btn.ghost { 
    background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .btn.ghost:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateY(-1px);
  }
  .small { padding:8px 12px; font-size:13px; border-radius:10px; }

  /* layout content area: map + right column or stacked on mobile */
  .content {
    flex:1; display:flex; gap:16px; align-items:stretch; min-height:0; /* allow children to scroll */
  }

  /* Page sections for navigation */
  .page-section {
    display: none;
    flex: 1;
    flex-direction: column;
    gap: 14px;
    padding: 18px;
    overflow: hidden;
    opacity: 0;
    transform: translateY(30px) scale(0.95);
    transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    filter: blur(2px);
  }
  .page-section.active {
    display: flex;
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0px);
  }
  .page-section.map-view {
    display: flex;
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0px);
  }

  /* map column */
  .col-left {
    flex: 1.6; min-width:280px; border-radius:16px; overflow:hidden; background:var(--card-2); box-shadow: 0 10px 30px rgba(2,6,23,0.06); position:relative;
    display:flex; flex-direction:column; z-index:1;
  }

  #map { height:100%; min-height:360px; width:100%; }

  /* right column (list + session + history) */
  .col-right {
    flex:1; min-width:320px; display:flex; flex-direction:column; gap:14px; max-height:calc(100vh - 180px);
  }

  .panel {
    background:var(--card); border-radius:14px; padding:12px; box-shadow: 0 8px 22px rgba(2,6,23,0.06); overflow:auto;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .panel:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 16px 40px rgba(2,6,23,0.15);
  }

  .token-balance { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; font-weight:700; background:linear-gradient(90deg,#e6ffef,#ddf7e6); color:#0b7a3f; }

  /* stations list */
  .stations-list { display:grid; grid-template-columns: 1fr; gap:10px; }
  .station {
    border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; background: linear-gradient(135deg,#ffffff,#f5fbff);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    cursor: pointer;
  }
  body.dark .station { background: linear-gradient(135deg,#14141b,#1c1c2b); }
  .station:hover { 
    transform: translateY(-8px) scale(1.02); 
    box-shadow: 0 20px 40px rgba(20,32,80,0.15);
    background: linear-gradient(135deg,#f8fbff,#e8f4ff);
    filter: brightness(1.05);
  }
  body.dark .station:hover {
    background: linear-gradient(135deg,#1a1a2e,#16213e);
    filter: brightness(1.1);
  }

  .station .head { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .station h3 { margin:0; font-size:15px; color:var(--text); }
  .station .status { padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; }

  /* connectors: high-contrast pills */
  .connectors { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
  .connector-row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .connector-meta { font-size:13px; color:var(--text); font-weight:600; }
  .connector-pill {
    padding:7px 12px; border-radius:14px; font-weight:800; font-size:13px; min-width:86px; text-align:center;
    color:#fff; box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  }
  /* connector colors good contrast */
  .available { background: linear-gradient(90deg,#0f9d58,#0fbf6f); color:#fff; }
  .occupied  { background: linear-gradient(90deg,#ef4444,#ff6b6b); color:#fff; }
  .maintenance { background: linear-gradient(90deg,#fbbf24,#fef08a); color:#1f2937; }

  .connector-action {
    border:none; padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; min-width:90px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  .connector-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  .connector-action:active { 
    transform: scale(.95) translateY(0);
    transition: all 0.1s ease;
  }

  .start-btn { background: linear-gradient(90deg,#06b6d4,#3b82f6); color:#fff; box-shadow:0 8px 28px rgba(59,130,246,0.18); }
  .stop-btn  { background: linear-gradient(90deg,#ef4444,#fb7185); color:#fff; }

  /* History table responsive wrapper */
  .history-wrapper { overflow-x:auto; }
  table.history { width:100%; border-collapse:collapse; min-width:640px; }
  table.history th, table.history td { padding:10px 12px; border-bottom:1px solid rgba(2,6,23,0.06); font-size:13px; text-align:left; }
  body.dark table.history th, body.dark table.history td { border-bottom:1px solid rgba(255,255,255,0.04); }

  /* ---------- Bottom sheet (station details) ---------- */
  .sheet {
    position:fixed; left:0; right:0; bottom:-100%; height:52vh; max-height:64vh; background:var(--card); border-top-left-radius:18px; border-top-right-radius:18px; box-shadow: 0 -20px 60px rgba(2,6,23,0.22);
    transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    z-index:120;
    padding:14px;
    display:flex; flex-direction:column; gap:12px;
    opacity: 0;
    transform: translateY(40px) scale(0.95);
    filter: blur(3px);
  }
  .sheet.open { 
    bottom:0.5vh; 
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0px);
  }
  .sheet .drag { width:56px; height:6px; background:rgba(0,0,0,0.08); border-radius:6px; margin:6px auto; }
  .sheet .sheet-body { overflow:auto; padding:6px; display:flex; flex-direction:column; gap:12px; }

  /* overlay when sidebar open or sheet open */
  .overlay {
    position:fixed; inset:0; background:rgba(2,6,23,0.35); opacity:0; pointer-events:none; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(0px);
    z-index:80;
  }
  .overlay.visible { 
    opacity:1; 
    pointer-events:auto;
    backdrop-filter: blur(4px);
  }

  /* Floating menu toggle for mobile - hidden since sidebar is always visible */
  .menu-toggle {
    display: none;
  }

  /* theme toggle bottom-right (emoji only) */
  .theme-toggle {
    position:fixed; bottom:18px; right:18px; width:50px; height:50px; border-radius:50%; display:grid; place-items:center; font-size:20px; z-index:140;
    background:var(--accent-2); color:#fff; box-shadow:0 12px 25px rgba(0,0,0,0.18); cursor:pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    opacity: 0;
    transform: translateY(30px) scale(0.8);
    animation: themeToggleFadeIn 1s ease-out 0.5s forwards;
  }
  .theme-toggle:hover {
    transform: scale(1.15) translateY(-4px);
    box-shadow: 0 20px 45px rgba(0,0,0,0.3);
    filter: brightness(1.2);
  }
  .theme-toggle:active {
    transform: scale(1.08) translateY(-2px);
    transition: all 0.15s ease;
  }
  
  @keyframes themeToggleFadeIn {
    0% {
      opacity: 0;
      transform: translateY(30px) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Input field styling for dark mode */
  input[type="number"] {
    color: var(--text) !important;
    background: var(--card) !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
  }
  body.dark input[type="number"] {
    border: 1px solid rgba(255,255,255,0.1) !important;
  }
  input[type="number"]::placeholder {
    color: rgba(0,0,0,0.5);
  }
  body.dark input[type="number"]::placeholder {
    color: rgba(255,255,255,0.5);
  }

  /* Small screens adjustments */
  @media (max-width: 900px){
    .content { flex-direction:column; }
    .col-left { min-height:320px; order:1; }
    .col-right { order:2; max-height:unset; min-height:0; }
    
    /* Hide active session and history from main page on mobile */
    .session-card { display:none !important; }
    
    /* Hide charging history panel on mobile */
    .col-right .panel:last-of-type { display:none !important; }
    
    .sidebar { 
      display:none; /* Hidden by default on mobile */
      position:fixed; left:0; top:0; bottom:0; 
      width:50px; min-width:50px;
      padding:8px 6px; gap:6px;
      z-index:180; /* Higher than toggle button */
      transform: translateX(-50px);
      transition: transform 0.3s ease;
    }
    .sidebar.visible {
      display:flex;
      transform: translateX(0);
    }
    .sidebar .icon-btn {
      width:38px; height:38px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1;
    }
    .menu-toggle { 
      display:grid; /* Show toggle button on mobile */
      position:fixed; top:12px; left:12px; 
      width:44px; height:44px; 
      border-radius:50%; 
      background:var(--glass); 
      backdrop-filter: blur(8px);
      box-shadow:0 6px 18px rgba(2,6,23,0.12); 
      cursor:pointer;
      z-index:160; /* Lower than navbar */
      color:#fff;
      font-size:18px;
      border:none;
      transition: transform 0.2s ease, background 0.2s;
    }
    .menu-toggle:hover {
      transform: scale(1.05);
      background: rgba(255,255,255,0.15);
    }
    .overlay { 
      display:block;
      z-index:150;
    }
    
    /* Fix mobile blur issues */
    .sheet { 
      filter: none !important; /* Remove blur on mobile */
      backdrop-filter: none !important;
    }
    
    /* Remove blur effects on mobile for better performance */
    .page-section {
      filter: none !important;
    }
    
    /* Simplify animations on mobile */
    .station {
      transition: transform 0.2s ease;
    }
    .station:hover {
      transform: translateY(-4px) scale(1.01);
    }
    
    /* Fix mobile panel blur issues */
    .panel {
      filter: none !important;
    }
    
    /* Ensure station details are visible on mobile */
    .station-details {
      filter: none !important;
      backdrop-filter: none !important;
    }
    
    /* Fix overlay blur on mobile */
    .overlay {
      backdrop-filter: none !important;
    }
    
    /* Quick mobile touch fixes */
    .sheet {
      z-index: 999 !important;
      pointer-events: auto !important;
    }
    
    .sheet .btn, .sheet .connector-action {
      pointer-events: auto !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
    }
    
    .theme-toggle {
      z-index: 1000 !important;
      pointer-events: auto !important;
      touch-action: manipulation !important;
    }
  }

  @media (min-width:901px){
    .menu-toggle { display:none; }
  }

  /* small utility */
  .muted { color:rgba(0,0,0,0.45); }
  body.dark .muted { color:rgba(255,255,255,0.45); }

  /* click bubble animation (for primary interactions) */
  .bubble {
    position:absolute; border-radius:50%; transform:scale(0); pointer-events:none; mix-blend-mode:screen; opacity:0.95;
    animation:bubble-pop .48s ease-out;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), rgba(255,255,255,0.06));
  }
  @keyframes bubble-pop { to { transform:scale(3); opacity:0; } }

  /* Loading animation for live feed */
  .loading-pulse {
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  /* Smooth fade-in for content */
  .fade-in {
    animation: fadeIn 0.5s ease-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

</style>
</head>
<body class="light">
  <div class="app">

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <button class="icon-btn" data-section="map" title="Map">🗺️</button>
      <button class="icon-btn" data-section="liveFeed" title="Live Feed">📡</button>
      <button class="icon-btn" data-section="trading" title="Trading">🔄</button>
      <button class="icon-btn" data-section="virtualWorld" title="Virtual World">🎮</button>
      <button class="icon-btn" data-section="history" title="History">📊</button>

      <div style="flex:1"></div>

      <button id="connectBtn" class="icon-btn" title="Connect Wallet">🔌</button>
    </div>

    <!-- overlay (used when mobile sidebar or bottom sheet open) -->
    <div class="overlay" id="overlay"></div>

    <!-- Floating menu (mobile) -->
    <button class="menu-toggle" id="menuToggle" title="Menu">☰</button>

    <!-- Main content -->
    <div class="main">
      <div class="header">
        <div class="brand">
          <div class="logo">EV</div>
          <div>
            <h1>EV Charging DApp</h1>
            <div class="muted" style="font-size:13px">Decentralized charging network</div>
          </div>
        </div>

        <div class="controls">
          <div id="tokenBalance" class="token-balance" style="display:none">🎁 <span id="tokenAmount">0</span> Rewards</div>
          <button id="quickConnect" class="btn small">Connect Phantom</button>
        </div>
      </div>

      <!-- Map View (default) -->
      <div class="page-section map-view active" id="mapSection">
        <div class="content">
          <!-- left: map -->
          <div class="col-left">
            <div id="map"></div>
          </div>

          <!-- right: list / session / history -->
          <div class="col-right">
            <!-- Stations list panel -->
            <div class="panel" style="min-height:140px; max-height:42vh; overflow:auto;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <h3 style="margin:0">Nearby Stations</h3>
                <div class="muted" id="stationsCount">—</div>
              </div>
              <div class="stations-list" id="stationsList"></div>
            </div>

            <!-- Active session -->
            <div class="panel session-card" id="activeSessionCard" style="display:none;">
              <h3 style="margin-top:0">Active Charging Session</h3>
              <div id="sessionDetails">No active session</div>
              <div style="margin-top:12px; display:flex; gap:10px;">
                <button class="btn stop-btn" id="endSessionBtn" style="flex:1; background:linear-gradient(90deg,#ef4444,#fb7185); color:#fff;">End Session & Pay</button>
              </div>
            </div>

            <!-- History -->
            <div class="panel" style="flex:1; overflow:auto;">
              <h3 style="margin-top:0">Charging History</h3>
              <div id="historyContent">
                <div class="history-wrapper">
                  <table class="history" id="historyTable">
                    <thead><tr><th>Date</th><th>Station</th><th>Energy (kWh)</th><th>Cost (₹)</th><th>Rewards</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="6" class="muted">No history yet</td></tr></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div> <!-- col-right -->
        </div> <!-- content -->
      </div> <!-- mapSection -->


      <!-- History View -->
      <div class="page-section" id="historySection">
        <div class="panel" style="flex:1; overflow:auto;">
          <h3 style="margin-top:0">Charging History</h3>
          <div id="historyContentFull">
            <div class="history-wrapper">
              <table class="history" id="historyTableFull">
                <thead><tr><th>Date</th><th>Station</th><th>Energy (kWh)</th><th>Cost (₹)</th><th>Rewards</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="6" class="muted">No history yet</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Live Feed View -->
      <div class="page-section" id="liveFeedSection">
        <div class="panel" style="flex:1; overflow:auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0">⚡ Live Charging Feed</h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <div class="muted" id="liveFeedCount">0 active sessions</div>
              <button onclick="refreshLiveFeed()" class="btn small" style="padding:6px 10px; font-size:12px;">🔄 Refresh</button>
            </div>
          </div>
          <div id="liveFeedContent">
            <div class="muted" style="text-align:center; padding:40px;">Loading live feed...</div>
          </div>
        </div>
      </div>

      <!-- Points Trading View -->
      <div class="page-section" id="tradingSection">
        <div class="panel" style="flex:1; overflow:auto;">
          <h3 style="margin-top:0">🔄 Points Trading</h3>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
            <div style="background:var(--card-2); padding:16px; border-radius:12px;">
              <h4 style="margin:0 0 8px 0; color:var(--text);">Your Points</h4>
              <div style="font-size:24px; font-weight:800; color:#0f9d58;" id="userPoints">0</div>
              <div class="muted" style="font-size:12px;">Earned from charging</div>
            </div>
            <div style="background:var(--card-2); padding:16px; border-radius:12px;">
              <h4 style="margin:0 0 8px 0; color:var(--text);">Market Price</h4>
              <div style="font-size:24px; font-weight:800; color:#667eea;" id="marketPrice">1 SOL = 100 pts</div>
              <div class="muted" style="font-size:12px;">Web3 users pay 50% more</div>
            </div>
          </div>
          
          <div style="background:linear-gradient(135deg,#e6ffef,#ddf7e6); padding:16px; border-radius:12px; margin-bottom:20px;">
            <h4 style="margin:0 0 8px 0; color:#0b7a3f;">💡 How it works</h4>
            <div style="font-size:14px; color:#0b7a3f;">
              • EV drivers earn points for every kWh charged<br>
              • Web3 users can buy your points at 50% discount<br>
              • Points can be used for premium features and rewards
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
              <h4 style="margin:0 0 8px 0;">Sell Points</h4>
              <div style="display:flex; gap:8px;">
                <input type="number" id="sellAmount" placeholder="Amount" style="flex:1; padding:8px; border-radius:8px;">
                <button onclick="sellPoints()" class="btn" style="background:linear-gradient(90deg,#0f9d58,#0fbf6f);">Sell</button>
              </div>
            </div>
            <div>
              <h4 style="margin:0 0 8px 0;">Buy Points</h4>
              <div style="display:flex; gap:8px;">
                <input type="number" id="buyAmount" placeholder="Amount" style="flex:1; padding:8px; border-radius:8px;">
                <button onclick="buyPoints()" class="btn" style="background:linear-gradient(90deg,#667eea,#764ba2);">Buy</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Virtual DeCharge Worlds View -->
      <div class="page-section" id="virtualWorldSection">
        <div class="panel" style="flex:1; overflow:auto;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0">🎮 Virtual DeCharge Worlds</h3>
            <div style="display:flex; gap:8px; align-items:center;">
              <div class="muted" id="worldStats">0 plots owned</div>
              <button onclick="refreshVirtualWorld()" class="btn small" style="padding:6px 10px; font-size:12px;">🔄 Refresh</button>
            </div>
          </div>
          
          <div style="background:linear-gradient(135deg,#f0f4ff,#e5eaff); padding:16px; border-radius:12px; margin-bottom:20px;">
            <h4 style="margin:0 0 8px 0; color:#667eea;">🎮 Gamified EV Ecosystem</h4>
            <div style="font-size:14px; color:#667eea;">
              • Own virtual plots and install chargers<br>
              • Limited charging spots create scarcity<br>
              • Let others charge their virtual vehicles<br>
              • Earn rewards from virtual charging sessions
            </div>
          </div>

          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:20px;">
            <div style="background:var(--card-2); padding:16px; border-radius:12px; text-align:center;">
              <div style="font-size:24px; margin-bottom:8px;">🏠</div>
              <div style="font-weight:800; margin-bottom:4px;">Your Plots</div>
              <div style="font-size:20px; color:#0f9d58;" id="ownedPlots">0</div>
            </div>
            <div style="background:var(--card-2); padding:16px; border-radius:12px; text-align:center;">
              <div style="font-size:24px; margin-bottom:8px;">⚡</div>
              <div style="font-weight:800; margin-bottom:4px;">Active Chargers</div>
              <div style="font-size:20px; color:#667eea;" id="activeChargers">0</div>
            </div>
            <div style="background:var(--card-2); padding:16px; border-radius:12px; text-align:center;">
              <div style="font-size:24px; margin-bottom:8px;">💰</div>
              <div style="font-weight:800; margin-bottom:4px;">Earnings</div>
              <div style="font-size:20px; color:#f59e0b;" id="virtualEarnings">0 pts</div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <button onclick="buyPlot()" class="btn" style="background:linear-gradient(90deg,#0f9d58,#0fbf6f); padding:12px;">
              🏠 Buy Plot (50 pts)
            </button>
            <button onclick="installCharger()" class="btn" style="background:linear-gradient(90deg,#667eea,#764ba2); padding:12px;">
              ⚡ Install Charger (25 pts)
            </button>
          </div>

          <div style="margin-top:20px;">
            <h4 style="margin:0 0 12px 0;">Virtual World Map</h4>
            <div id="virtualMap" style="height:300px; background:var(--card-2); border-radius:12px; display:grid; grid-template-columns: repeat(8, 1fr); gap:2px; padding:8px;">
              <!-- Virtual plots will be generated here -->
            </div>
          </div>
        </div>
      </div>
    </div> <!-- main -->

    <!-- bottom sheet station details -->
    <div class="sheet" id="sheet">
      <div class="drag"></div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3 id="sheetTitle" style="margin:0">Station name</h3>
          <div class="muted" id="sheetAddr" style="font-size:13px">Address</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div id="sheetStatus" class="station-status muted">Status</div>
          <button id="sheetClose" class="btn ghost small">Close</button>
        </div>
      </div>

      <div class="sheet-body">
        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
          <div class="muted">Connectors</div>
          <div class="muted" id="sheetPricing">Pricing</div>
        </div>

        <div id="sheetConnectors" style="display:flex; flex-direction:column; gap:10px;"></div>

        <div style="display:flex; gap:10px; margin-top:6px;">
          <button id="sheetStart" class="btn start-btn" style="flex:1; display:none;">Start Charging</button>
          <button id="sheetStop"  class="btn stop-btn"  style="flex:1; display:none;">Stop Charging</button>
        </div>
      </div>
    </div>

    <!-- theme toggle -->
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">🌓</button>
  </div>

<!-- Leaflet + Solana -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<script>
/* ===========================
   Utilities & small effects
   =========================== */

function makeRipple(el, e){
  const r = document.createElement('span'); r.className='ripple';
  el.appendChild(r);
  const rect = el.getBoundingClientRect();
  r.style.left = ( (e?.clientX || rect.left + rect.width/2) - rect.left ) + 'px';
  r.style.top  = ( (e?.clientY || rect.top + rect.height/2) - rect.top ) + 'px';
  setTimeout(()=> r.remove(), 600);
}
function bubbleEffect(parent, x, y){
  const b = document.createElement('span'); b.className='bubble';
  b.style.left = x+'px'; b.style.top = y+'px';
  parent.appendChild(b);
  setTimeout(()=> b.remove(), 480);
}

/* Base58 encode (used for Phantom signature) */
const BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
function base58Encode(buffer){
  const digits = [0];
  for (let i=0;i<buffer.length;i++){
    let carry = buffer[i];
    for (let j=0;j<digits.length;j++){
      carry += digits[j] << 8;
      digits[j] = carry % 58;
      carry = (carry/58)|0;
    }
    while(carry>0){
      digits.push(carry%58);
      carry = (carry/58)|0;
    }
  }
  // leading zeros
  for (let k=0; k<buffer.length-1 && buffer[k]===0; k++){
    digits.push(0);
  }
  return digits.reverse().map(d => BASE58_ALPHABET[d]).join('');
}

/* ===========================
   State & API config
   =========================== */
const API_BASE = window.location.href.split('://')[0]+"://"+window.location.href.split('://')[1].replace('/',''); // API_BASE.split('://')[1].replace('/','')
let walletPublicKey = null;
let map = null;
let markers = [];
let selectedStation = null;
let activeSessionInterval = null;

/* DOM references */
const overlay = document.getElementById('overlay');
const sidebar = document.getElementById('sidebar');
const menuToggle = document.getElementById('menuToggle');
const themeToggle = document.getElementById('themeToggle');
const connectBtn = document.getElementById('connectBtn');
const quickConnect = document.getElementById('quickConnect');
const tokenBalanceEl = document.getElementById('tokenBalance');
const tokenAmountEl = document.getElementById('tokenAmount');
const stationsListEl = document.getElementById('stationsList');
const stationsCountEl = document.getElementById('stationsCount');
const sheet = document.getElementById('sheet');
const sheetTitle = document.getElementById('sheetTitle');
const sheetAddr = document.getElementById('sheetAddr');
const sheetStatus = document.getElementById('sheetStatus');
const sheetConnectors = document.getElementById('sheetConnectors');
const sheetPricing = document.getElementById('sheetPricing');
const sheetClose = document.getElementById('sheetClose');
const sheetStart = document.getElementById('sheetStart');
const sheetStop = document.getElementById('sheetStop');
const activeSessionCard = document.getElementById('activeSessionCard');
const sessionDetails = document.getElementById('sessionDetails');
const endSessionBtn = document.getElementById('endSessionBtn');
const historyTbody = document.querySelector('#historyTable tbody');
const historyTbodyFull = document.querySelector('#historyTableFull tbody');

/* ---------- UI interactions: sidebar + menu toggle + overlay ---------- */
let sidebarTimeout = null;

function openSidebar(){
  sidebar.classList.add('visible'); 
  overlay.classList.add('visible');
  
  // Clear any existing timeout
  if (sidebarTimeout) {
    clearTimeout(sidebarTimeout);
  }
  
  // Auto-hide after 6 seconds
  sidebarTimeout = setTimeout(() => {
    closeSidebar();
  }, 6000);
}

function closeSidebar(){
  sidebar.classList.remove('visible'); 
  overlay.classList.remove('visible');
  
  // Clear timeout when manually closed
  if (sidebarTimeout) {
    clearTimeout(sidebarTimeout);
    sidebarTimeout = null;
  }
}

menuToggle.addEventListener('click', (e)=>{
  const visible = sidebar.classList.contains('visible');
  if(visible) closeSidebar(); else openSidebar();
});

overlay.addEventListener('click', ()=>{
  closeSidebar(); 
  closeSheet();
});

/* ripple on sidebar icons */
document.querySelectorAll('.sidebar .icon-btn').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    makeRipple(btn, e);
    const section = btn.dataset.section;
    switchSection(section);
    // Close sidebar on mobile after navigation
    if(window.innerWidth < 901) {
      setTimeout(()=> closeSidebar(), 250);
    }
  });
  
  // Reset auto-hide timer when hovering over sidebar buttons
  btn.addEventListener('mouseenter', () => {
    if (sidebarTimeout) {
      clearTimeout(sidebarTimeout);
      // Restart the timer
      sidebarTimeout = setTimeout(() => {
        closeSidebar();
      }, 6000);
    }
  });
});

/* header connect buttons */
connectBtn.addEventListener('click', ()=> connectWallet());
quickConnect.addEventListener('click', ()=> connectWallet());

/* theme toggle */
themeToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  document.body.classList.toggle('dark');
});

/* ---------- Map initialization ---------- */
function initMap(){
  if(map) return;
  map = L.map('map', { zoomControl: false }).setView([20.5937,78.9629], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);
  // small zoom control position
  L.control.zoom({ position: 'bottomright' }).addTo(map);
}

/* ---------- Stations display ---------- */
async function loadStations(){
  try{
    const resp = await fetch(`${API_BASE}/stations`);
    const data = await resp.json();
    const stations = data.charge_points || [];
    renderStationsList(stations);
    renderStationsMap(stations);
    stationsCountEl.textContent = `${stations.length} found`;
  }catch(e){
    console.error('loadStations', e);
  }
}

function clearMarkers(){
  markers.forEach(m => m.remove());
  markers = [];
}

function renderStationsMap(stations){
  initMap();
  clearMarkers();
  stations.forEach(st => {
    const marker = L.marker([st.location.latitude, st.location.longitude]).addTo(map);
    marker.bindPopup(`<strong>${st.name}</strong><br>${st.location.address}<br>Status: ${st.status}`);
    marker.on('click', ()=> {
      openSheetForStation(st);
    });
    markers.push(marker);
  });
}

function renderStationsList(stations){
  stationsListEl.innerHTML = '';
  stations.forEach(st => {
    const el = document.createElement('div'); el.className = 'station';
    const statusClass = st.status === 'active' ? 'status-active' : (st.status==='maintenance' ? 'status-maintenance' : 'status-offline');
    el.innerHTML = `
      <div class="head">
        <div>
          <h3>${st.name}</h3>
          <div class="muted" style="font-size:12px">${st.location.address}</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
          <div class="status ${statusClass}" style="padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;">${st.status}</div>
          <div class="muted" style="font-size:12px">₹${st.pricing.energy_based.rate}/kWh</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:6px; align-items:center;">
        <div style="flex:1; display:flex; gap:6px; flex-wrap:wrap;">
          ${st.connectors.slice(0,3).map(c => `<div style="padding:6px 10px; border-radius:10px; font-weight:700; font-size:12px; background:rgba(0,0,0,0.04)">${c.type} ${c.power_kw}kW</div>`).join('')}
        </div>
        <button class="btn small" style="min-width:98px" data-code="${st.code}">Details</button>
      </div>
    `;
    // click station card => open sheet
    el.querySelector('button').addEventListener('click', (ev)=>{
      makeRipple(ev.target, ev);
      openSheetForStation(st);
    });
    // bubble effect on primary area
    el.addEventListener('click', (e)=>{
      const rect = el.getBoundingClientRect();
      bubbleEffect(el, e.clientX - rect.left, e.clientY - rect.top);
    });

    stationsListEl.appendChild(el);
  });
}

/* ---------- bottom sheet handling ---------- */
function openSheetForStation(station){
  selectedStation = station;
  sheetTitle.textContent = station.name;
  sheetAddr.textContent = station.location.address;
  sheetStatus.textContent = station.status;
  sheetStatus.className = 'station-status ' + (station.status==='active' ? 'status-active' : station.status==='maintenance' ? 'status-maintenance' : 'status-offline');
  sheetPricing.textContent = `₹${station.pricing.energy_based.rate}/kWh • ₹${station.pricing.time_based.rate}/min`;
  sheetConnectors.innerHTML = '';

  station.connectors.forEach(conn => {
    const row = document.createElement('div'); row.className = 'connector-row';
    const meta = document.createElement('div'); meta.className = 'connector-meta';
    meta.innerHTML = `${conn.id} • ${conn.type} • ${conn.power_kw}kW`;

    const pill = document.createElement('div'); pill.className = 'connector-pill';
    if (conn.status === 'available'){ pill.classList.add('available'); pill.textContent = 'AVAILABLE'; }
    else if (conn.status === 'occupied'){ pill.classList.add('occupied'); pill.textContent = 'OCCUPIED'; }
    else { pill.classList.add('maintenance'); pill.textContent = 'MAINTENANCE'; }

    const action = document.createElement('button'); action.className = 'connector-action';
    action.style.fontWeight = 800;
    if (conn.status === 'available'){
      action.classList.add('start-btn');
      action.textContent = 'Start';
      action.addEventListener('click', async (ev)=>{
        makeRipple(action, ev);
        await startCharging(station.code, conn.id);
        // quick UI refresh
        await loadStations();
        closeSheet();
      });
    } else {
      action.classList.add('stop-btn');
      action.textContent = '—';
      action.disabled = true;
      action.style.opacity = 0.6;
    }

    const container = document.createElement('div');
    container.style.display = 'flex'; container.style.alignItems='center'; container.style.gap='10px';
    container.appendChild(pill);
    container.appendChild(action);

    row.appendChild(meta);
    row.appendChild(container);
    sheetConnectors.appendChild(row);
  });

  sheet.classList.add('open'); overlay.classList.add('visible');
}

/* close sheet */
function closeSheet(){
  sheet.classList.remove('open'); overlay.classList.remove('visible');
}
sheetClose.addEventListener('click', closeSheet);

/* ---------- Connect wallet + sign message ---------- */
function getProvider(){
  if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
  if (window.solana && window.solana.isPhantom) return window.solana;
  // open phantom landing if not installed
  window.open('https://phantom.app/', '_blank');
  return null;
}

async function connectWallet(){
  try{
    const provider = getProvider();
    if (!provider) throw new Error('Phantom not found');
    const res = await provider.connect();
    walletPublicKey = res.publicKey.toString();
    document.getElementById('connectBtn').textContent = '✓';
    document.getElementById('quickConnect').textContent = walletPublicKey.slice(0,6) + '...' + walletPublicKey.slice(-4);
    tokenBalanceEl.style.display = 'inline-flex';
    // load user-specific data
    await loadTokenBalance();
    await loadStations();
    await checkActiveSession();
    await loadHistory();
  }catch(err){
    console.error('connectWallet', err);
    alert('Wallet connect failed: ' + (err.message||err));
  }
}

/* sign message (nonce) -> base58 signature */
async function signMessage(message){
  const provider = getProvider();
  if (!provider) throw new Error('Wallet provider missing');
  const encoded = new TextEncoder().encode(message);
  const signed = await provider.signMessage(encoded, 'utf8'); // returns { signature: Uint8Array }
  return base58Encode(signed.signature);
}

/* ---------- Start/End charging ---------- */
async function startCharging(stationCode, connectorId){
  try{
    if (!walletPublicKey) { alert('Connect wallet first'); return; }
    // get nonce
    const nres = await fetch(`${API_BASE}/nonce`);
    const ndata = await nres.json();
    const nonce = ndata.nonce;
    // sign
    const signature = await signMessage(nonce);
    // post to startCharge
    const resp = await fetch(`${API_BASE}/startCharge`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ publicKey: walletPublicKey, signature, nonce, stationCode, connectorId })
    });
    const data = await resp.json();
    if (data.success){
      alert('Charging session started!');
    } else {
      alert('Error: ' + (data.error || 'unknown'));
    }
  }catch(err){
    console.error('startCharging', err);
    alert('Failed to start charging: ' + (err.message||err));
  }
}

async function checkActiveSession(){
  try{
    if (!walletPublicKey) return;
    const resp = await fetch(`${API_BASE}/monitor?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    if (data.sessions && data.sessions.length > 0){
      const session = data.sessions[0];
      renderActiveSession(session);
      if (activeSessionInterval) clearInterval(activeSessionInterval);
      activeSessionInterval = setInterval(checkActiveSession, 4000);
    } else {
      activeSessionCard.style.display = 'none';
      if(activeSessionInterval){ clearInterval(activeSessionInterval); activeSessionInterval = null; }
    }
  }catch(err){ console.error('checkActiveSession', err); }
}

function renderActiveSession(s){
  // Show active session card in map view
    activeSessionCard.style.display = 'block';
  
  const mins = Math.floor(s.timeElapsedSeconds/60), secs = s.timeElapsedSeconds % 60;
  const timeCost = (s.timeElapsedSeconds/60) * s.pricing.time_based.rate;
  const energyCost = s.kwhUsed * s.pricing.energy_based.rate;
  const total = timeCost + energyCost;
  const sessionHTML = `
    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px;">
      <div style="background:var(--card-2); padding:10px; border-radius:10px;">
        <div class="muted">Energy Used</div><div style="font-weight:800; font-size:18px">${s.kwhUsed.toFixed(2)} kWh</div>
      </div>
      <div style="background:var(--card-2); padding:10px; border-radius:10px;">
        <div class="muted">Time</div><div style="font-weight:800; font-size:18px">${mins}m ${secs}s</div>
      </div>
      <div style="background:var(--card-2); padding:10px; border-radius:10px;">
        <div class="muted">Estimated Cost</div><div style="font-weight:800; font-size:18px">₹${total.toFixed(2)}</div>
      </div>
      <div style="background:var(--card-2); padding:10px; border-radius:10px;">
        <div class="muted">Rewards</div><div style="font-weight:800; font-size:18px">${Math.floor(s.kwhUsed)} 🎁</div>
      </div>
    </div>
  `;
  sessionDetails.innerHTML = sessionHTML;
}

/* End session (payment via Solana) */
endSessionBtn.addEventListener('click', endSession);

async function endSession(){
  try{
    if (!walletPublicKey) { alert('Connect wallet first'); return; }
    // fetch current session
    const resp = await fetch(`${API_BASE}/monitor?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    if (!data.sessions || data.sessions.length === 0){ alert('No active session'); return; }
    const session = data.sessions[0];
    const timeCost = (session.timeElapsedSeconds/60) * session.pricing.time_based.rate;
    const energyCost = session.kwhUsed * session.pricing.energy_based.rate;
    const totalCost = timeCost + energyCost;
    const totalSOL = totalCost / 100; // simplified conversion — adjust as you want

    if (!confirm(`Total Cost: ₹${totalCost.toFixed(2)} (~${totalSOL.toFixed(4)} SOL)\nProceed with payment?`)) return;

    const provider = getProvider();
    if (!provider) throw new Error('Phantom not available');

    // build transaction — replace server wallet below if necessary
    const serverWallet = new window.solanaWeb3.PublicKey('C6rNnPKxXSTSWxdMH3ZWmZG7ZwXhPurPbUkGuyvtDzT4');

    const connection = new window.solanaWeb3.Connection('https://api.devnet.solana.com');
    const tx = new window.solanaWeb3.Transaction().add(
      window.solanaWeb3.SystemProgram.transfer({
        fromPubkey: provider.publicKey,
        toPubkey: serverWallet,
        lamports: Math.floor(totalSOL * 1e9)
      })
    );

    tx.feePayer = provider.publicKey;
    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

    const signed = await provider.signTransaction(tx);
    const txSig = await connection.sendRawTransaction(signed.serialize());
    await connection.confirmTransaction(txSig);

    // ensure base58 string (it should be)
    if (typeof txSig !== 'string') {
      console.error('txSig not string', txSig);
      alert('Payment failed (invalid tx signature).');
      return;
    }

    // call backend to end session (pass txSig)
    const endResp = await fetch(`${API_BASE}/endCharge`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sessionId: session.id, txSignature: txSig })
    });
    const endData = await endResp.json();
    if (endData.success){
      alert(`Session ended! You earned ${endData.session.rewardTokens} reward tokens!`);
      await loadStations();
      await checkActiveSession();
      await loadHistory();
      await loadTokenBalance();
    } else {
      alert('Error ending session: ' + (endData.error || 'unknown'));
    }
  }catch(err){
    console.error('endSession', err);
    alert('Failed to end session: ' + (err.message || err));
  }
}

/* ---------- History + token balance ---------- */
async function loadHistory(){
  try{
    if (!walletPublicKey) return;
    const resp = await fetch(`${API_BASE}/history?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    const history = data.history || [];
    historyTbody.innerHTML = '';
    if (history.length === 0){
      historyTbody.innerHTML = '<tr><td colspan="6" class="muted">No charging history yet</td></tr>';
      // Also update full view
      if (historyTbodyFull) {
        historyTbodyFull.innerHTML = '<tr><td colspan="6" class="muted">No charging history yet</td></tr>';
      }
      return;
    }
    history.forEach(r => {
      const date = new Date(r.completedAt).toLocaleDateString();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${date}</td><td>${r.stationCode} - ${r.connectorId}</td><td>${r.kwhUsed.toFixed(2)}</td><td>₹${(r.totalCost||0).toFixed(2)}</td><td>${r.rewardTokens||0} 🎁</td><td>${r.status}</td>`;
      historyTbody.appendChild(tr);
    });
    // Also update full view
    if (historyTbodyFull) {
      historyTbodyFull.innerHTML = historyTbody.innerHTML;
    }
  }catch(err){ console.error('loadHistory', err); }
}

async function loadTokenBalance(){
  try{
    if (!walletPublicKey) return;
    
    const resp = await fetch(`${API_BASE}/userPoints?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    
    tokenAmountEl.textContent = data.totalPoints || 0;
    tokenBalanceEl.style.display = 'inline-flex';
  }catch(err){ 
    console.error('loadTokenBalance', err);
    tokenAmountEl.textContent = '0';
    tokenBalanceEl.style.display = 'inline-flex';
  }
}

/* ---------- Live Feed Functions ---------- */
async function loadLiveFeed(){
  try{
    const resp = await fetch(`${API_BASE}/admin/sessions`);
    const data = await resp.json();
    const allSessions = data.sessions || [];
    const activeSessions = allSessions.filter(s => s.status === 'charging');
    
    document.getElementById('liveFeedCount').textContent = `${activeSessions.length} active sessions`;
    
    const feedContent = document.getElementById('liveFeedContent');
    if (activeSessions.length === 0) {
      feedContent.innerHTML = '<div class="muted" style="text-align:center; padding:40px;">No active charging sessions</div>';
      return;
    }
    
    feedContent.innerHTML = activeSessions.map(session => {
      const mins = Math.floor(session.timeElapsedSeconds / 60);
      const secs = session.timeElapsedSeconds % 60;
      const pointsEarned = Math.floor(session.kwhUsed);
      const timeCost = (session.timeElapsedSeconds / 60) * session.pricing.time_based.rate;
      const energyCost = session.kwhUsed * session.pricing.energy_based.rate;
      const totalCost = timeCost + energyCost;
      
      return `
        <div class="fade-in" style="background:var(--card-2); border-radius:12px; padding:16px; margin-bottom:12px; border-left:4px solid #0f9d58; transition: all 0.3s ease;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800; color:var(--text);">${session.stationCode} - ${session.connectorId}</div>
            <div style="font-size:12px; color:#0f9d58; font-weight:800;">+${pointsEarned} pts</div>
          </div>
          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; font-size:13px;">
            <div><span class="muted">Energy:</span> ${session.kwhUsed.toFixed(2)} kWh</div>
            <div><span class="muted">Time:</span> ${mins}m ${secs}s</div>
            <div><span class="muted">Cost:</span> ₹${totalCost.toFixed(2)}</div>
          </div>
          <div style="margin-top:8px; font-size:12px; color:var(--text);">
            User: ${session.publicKey.slice(0, 6)}...${session.publicKey.slice(-4)}
          </div>
        </div>
      `;
    }).join('');
    
  } catch(err) {
    console.error('loadLiveFeed', err);
    document.getElementById('liveFeedContent').innerHTML = '<div class="muted" style="text-align:center; padding:40px;">Error loading live feed</div>';
  }
}

function refreshLiveFeed(){
  loadLiveFeed();
}

/* ---------- Points Trading Functions ---------- */
async function loadUserPoints(){
  try{
    if (!walletPublicKey) return;
    const resp = await fetch(`${API_BASE}/userPoints?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    document.getElementById('userPoints').textContent = data.totalPoints || 0;
  } catch(err) {
    console.error('loadUserPoints', err);
  }
}

async function sellPoints(){
  const amount = parseInt(document.getElementById('sellAmount').value);
  if (!amount || amount <= 0) {
    alert('Please enter a valid amount');
    return;
  }
  
  if (!walletPublicKey) {
    alert('Connect wallet first');
    return;
  }
  
  try{
    const resp = await fetch(`${API_BASE}/sellPoints`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ publicKey: walletPublicKey, amount })
    });
    const data = await resp.json();
    
    if (data.success) {
      const message = `✅ Successfully listed ${amount} points for sale!\n\n` +
        `📊 Order Details:\n` +
        `• You'll receive: ${data.totalSellerValue.toFixed(4)} SOL\n` +
        `• Buyers pay: ${data.totalBuyerCost.toFixed(4)} SOL\n` +
        `• Order ID: ${data.orderId.slice(-8)}`;
      alert(message);
      document.getElementById('sellAmount').value = '';
      await loadUserPoints();
    } else {
      alert('❌ Error: ' + (data.error || 'Failed to sell points'));
    }
  } catch(err) {
    console.error('sellPoints', err);
    alert('❌ Failed to sell points: ' + (err.message || err));
  }
}

async function buyPoints(){
  const amount = parseInt(document.getElementById('buyAmount').value);
  if (!amount || amount <= 0) {
    alert('Please enter a valid amount');
    return;
  }
  
  if (!walletPublicKey) {
    alert('Connect wallet first');
    return;
  }
  
  const costSOL = amount * 0.015; // 50% discount: 1 SOL = 100 pts, so 1 pt = 0.01 SOL, but with 50% markup = 0.015 SOL
  
  if (!confirm(`Buy ${amount} points for ${costSOL.toFixed(4)} SOL?`)) return;
  
  try{
    const provider = getProvider();
    if (!provider) throw new Error('Phantom not available');
    
    const serverWallet = new window.solanaWeb3.PublicKey('C6rNnPKxXSTSWxdMH3ZWmZG7ZwXhPurPbUkGuyvtDzT4');
    const connection = new window.solanaWeb3.Connection('https://api.devnet.solana.com');
    const tx = new window.solanaWeb3.Transaction().add(
      window.solanaWeb3.SystemProgram.transfer({
        fromPubkey: provider.publicKey,
        toPubkey: serverWallet,
        lamports: Math.floor(costSOL * 1e9)
      })
    );
    
    tx.feePayer = provider.publicKey;
    tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
    
    const signed = await provider.signTransaction(tx);
    const txSig = await connection.sendRawTransaction(signed.serialize());
    await connection.confirmTransaction(txSig);
    
    // Call backend to process points purchase
    const resp = await fetch(`${API_BASE}/buyPoints`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        publicKey: walletPublicKey, 
        amount, 
        txSignature: txSig 
      })
    });
    const data = await resp.json();
    
    if (data.success) {
      const message = `✅ Successfully purchased ${amount} points!\n\n` +
        `📊 Transaction Details:\n` +
        `• Points received: ${data.pointsReceived}\n` +
        `• Total cost: ${data.cost.toFixed(4)} SOL\n` +
        `• Seller: ${data.seller.slice(0, 6)}...${data.seller.slice(-4)}\n` +
        `• Transaction ID: ${data.transaction.id.slice(-8)}`;
      alert(message);
      document.getElementById('buyAmount').value = '';
      await loadUserPoints();
    } else {
      alert('❌ Error: ' + (data.error || 'Failed to buy points'));
    }
  } catch(err) {
    console.error('buyPoints', err);
    alert('Failed to buy points: ' + (err.message || err));
  }
}

/* ---------- Virtual DeCharge Worlds Functions ---------- */
let virtualWorldData = {
  plots: [], // Array of plot objects
  userPlots: [], // User's owned plots
  userChargers: [] // User's installed chargers
};

async function loadVirtualWorld(){
  try{
    if (!walletPublicKey) return;
    
    // Generate virtual world if not exists
    if (virtualWorldData.plots.length === 0) {
      generateVirtualWorld();
    }
    
    // Load user's virtual assets
    const resp = await fetch(`${API_BASE}/virtualWorld?pubkey=${walletPublicKey}`);
    const data = await resp.json();
    
    virtualWorldData.userPlots = data.userPlots || [];
    virtualWorldData.userChargers = data.userChargers || [];
    
    updateVirtualWorldStats();
    renderVirtualMap();
    
  } catch(err) {
    console.error('loadVirtualWorld', err);
  }
}

function generateVirtualWorld(){
  // Generate 64 plots (8x8 grid)
  virtualWorldData.plots = [];
  for (let i = 0; i < 64; i++) {
    virtualWorldData.plots.push({
      id: i,
      x: i % 8,
      y: Math.floor(i / 8),
      owner: null,
      hasCharger: false,
      chargerType: null,
      price: 50 + Math.floor(Math.random() * 50) // 50-100 points
    });
  }
}

function updateVirtualWorldStats(){
  const ownedPlots = virtualWorldData.userPlots.length;
  const activeChargers = virtualWorldData.userChargers.length;
  const earnings = virtualWorldData.userChargers.length * 5; // 5 points per charger per day
  
  document.getElementById('ownedPlots').textContent = ownedPlots;
  document.getElementById('activeChargers').textContent = activeChargers;
  document.getElementById('virtualEarnings').textContent = earnings + ' pts';
  document.getElementById('worldStats').textContent = `${ownedPlots} plots owned`;
}

function renderVirtualMap(){
  const mapEl = document.getElementById('virtualMap');
  mapEl.innerHTML = '';
  
  virtualWorldData.plots.forEach(plot => {
    const plotEl = document.createElement('div');
    plotEl.style.cssText = `
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    `;
    
    // Determine plot appearance
    if (plot.owner === walletPublicKey) {
      plotEl.style.background = 'linear-gradient(135deg, #0f9d58, #0fbf6f)';
      plotEl.style.color = 'white';
      plotEl.innerHTML = plot.hasCharger ? '⚡' : '🏠';
    } else if (plot.owner) {
      plotEl.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
      plotEl.style.color = 'white';
      plotEl.innerHTML = plot.hasCharger ? '⚡' : '🏠';
    } else {
      plotEl.style.background = 'var(--card)';
      plotEl.style.color = 'var(--text)';
      plotEl.innerHTML = '🟫';
    }
    
    plotEl.addEventListener('click', () => {
      if (!plot.owner) {
        buyPlot(plot.id);
      } else if (plot.owner === walletPublicKey && !plot.hasCharger) {
        installCharger(plot.id);
      }
    });
    
    mapEl.appendChild(plotEl);
  });
}

async function buyPlot(plotId = null){
  if (!walletPublicKey) {
    alert('Connect wallet first');
    return;
  }
  
  const plot = virtualWorldData.plots[plotId];
  if (!plot) return;
  
  if (plot.owner) {
    alert('This plot is already owned');
    return;
  }
  
  const cost = plot.price;
  if (!confirm(`Buy this plot for ${cost} points?`)) return;
  
  try{
    const resp = await fetch(`${API_BASE}/buyVirtualPlot`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        publicKey: walletPublicKey, 
        plotId,
        cost 
      })
    });
    const data = await resp.json();
    
    if (data.success) {
      alert(`Successfully bought plot ${plotId}!`);
      plot.owner = walletPublicKey;
      virtualWorldData.userPlots.push(plot);
      updateVirtualWorldStats();
      renderVirtualMap();
    } else {
      alert('Error: ' + (data.error || 'Failed to buy plot'));
    }
  } catch(err) {
    console.error('buyPlot', err);
    alert('Failed to buy plot: ' + (err.message || err));
  }
}

async function installCharger(plotId = null){
  if (!walletPublicKey) {
    alert('Connect wallet first');
    return;
  }
  
  const plot = virtualWorldData.plots[plotId];
  if (!plot || plot.owner !== walletPublicKey) {
    alert('You must own this plot to install a charger');
    return;
  }
  
  if (plot.hasCharger) {
    alert('This plot already has a charger');
    return;
  }
  
  const cost = 25;
  if (!confirm(`Install charger for ${cost} points?`)) return;
  
  try{
    const resp = await fetch(`${API_BASE}/installVirtualCharger`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        publicKey: walletPublicKey, 
        plotId,
        cost 
      })
    });
    const data = await resp.json();
    
    if (data.success) {
      alert(`Successfully installed charger on plot ${plotId}!`);
      plot.hasCharger = true;
      plot.chargerType = 'standard';
      virtualWorldData.userChargers.push(plot);
      updateVirtualWorldStats();
      renderVirtualMap();
    } else {
      alert('Error: ' + (data.error || 'Failed to install charger'));
    }
  } catch(err) {
    console.error('installCharger', err);
    alert('Failed to install charger: ' + (err.message || err));
  }
}

function refreshVirtualWorld(){
  loadVirtualWorld();
}

/* ---------- small helpers ---------- */
function switchSection(name){
  // Hide all page sections
  document.querySelectorAll('.page-section').forEach(s=> s.classList.remove('active'));
  
  if (name === 'map') {
    document.getElementById('mapSection').classList.add('active');
    // Show active session card in map view
    if (activeSessionCard) {
      activeSessionCard.style.display = activeSessionCard.style.display === 'none' ? 'none' : 'block';
    }
  } else if (name === 'liveFeed'){
    document.getElementById('liveFeedSection').classList.add('active');
    // Load live feed when switching to this section
    loadLiveFeed();
  } else if (name === 'trading'){
    document.getElementById('tradingSection').classList.add('active');
    // Load user points when switching to trading
    loadUserPoints();
  } else if (name === 'virtualWorld'){
    document.getElementById('virtualWorldSection').classList.add('active');
    // Load virtual world when switching to this section
    loadVirtualWorld();
  } else if (name === 'history'){
    document.getElementById('historySection').classList.add('active');
    // Show active session card in map view
    if (activeSessionCard) {
      activeSessionCard.style.display = activeSessionCard.style.display === 'none' ? 'none' : 'block';
    }
    // Update history in the full view
    updateHistoryFull();
  }
}


/* Update history in full view */
function updateHistoryFull(){
  historyTbodyFull.innerHTML = historyTbody.innerHTML;
}

/* ---------- startup ---------- */
window.addEventListener('load', async ()=>{
  initMap();
  await loadStations();
  // try silent connect if trusted
  try {
    const provider = getProvider();
    if (provider) {
      const resp = await provider.connect({ onlyIfTrusted: true }).catch(()=>null);
      if (resp && resp.publicKey) { walletPublicKey = resp.publicKey.toString(); document.getElementById('quickConnect').textContent = walletPublicKey.slice(0,6)+'...'+walletPublicKey.slice(-4); await loadTokenBalance(); await checkActiveSession(); await loadHistory(); }
    }
  }catch(e){ console.warn(e); }
});

/* Sidebar is now always visible, no resize handling needed */

/* Quick mobile touch fix */
document.addEventListener('DOMContentLoaded', function() {
  // Fix mobile touch events
  document.addEventListener('touchstart', function(e) {
    if (e.target.closest('.sheet')) {
      e.target.closest('.sheet').style.pointerEvents = 'auto';
    }
  }, { passive: true });
  
  // Ensure buttons work on mobile
  document.addEventListener('touchend', function(e) {
    if (e.target.classList.contains('btn') || e.target.classList.contains('connector-action')) {
      e.target.click();
    }
  }, { passive: true });
});

</script>
</body>
</html>
